name: ğŸš€ Build Windows Distribution

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: ğŸ’¾ Cache Dependencies
      uses: actions/cache@v4
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: ğŸ—ï¸ Build Executable with PyInstaller
      run: |
        pyinstaller --onefile --windowed --name ShotPipe main.py --add-data "shotpipe;shotpipe" --add-data "vendor;vendor"
        
    - name: ğŸ“‹ Verify Build
      run: |
        dir dist
        if (Test-Path "dist/ShotPipe.exe") {
          Write-Host "âœ… ShotPipe.exe generated successfully"
          $size = (Get-Item "dist/ShotPipe.exe").Length / 1MB
          Write-Host "ğŸ“ File size: $([math]::Round($size, 2)) MB"
        } else {
          Write-Host "âŒ ShotPipe.exe not found"
          exit 1
        }
        
    - name: ğŸ”§ Install NSIS
      run: |
        choco install nsis -y
        
    - name: ğŸ¯ Build NSIS Installer
      run: |
        # NSISë¥¼ PATHì— ì¶”ê°€
        $env:PATH += ";C:\Program Files (x86)\NSIS"
        
        # NSIS ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        makensis ShotPipe_Installer.nsi
        
        # ê²°ê³¼ í™•ì¸
        if (Test-Path "ShotPipe_v1.3.0_Setup.exe") {
          Write-Host "âœ… NSIS Installer generated successfully"
          $size = (Get-Item "ShotPipe_v1.3.0_Setup.exe").Length / 1MB
          Write-Host "ğŸ“ Installer size: $([math]::Round($size, 2)) MB"
        } else {
          Write-Host "âŒ NSIS Installer generation failed"
          exit 1
        }
        
    - name: ğŸ“¤ Upload Standalone Executable
      uses: actions/upload-artifact@v4
      with:
        name: ShotPipe-Windows-Standalone
        path: |
          dist/ShotPipe.exe
          README.md
          LICENSE.txt
          WINDOWS_USER_GUIDE.md
        retention-days: 30
        
    - name: ğŸ“¤ Upload NSIS Installer
      uses: actions/upload-artifact@v4
      with:
        name: ShotPipe-Windows-Installer
        path: |
          ShotPipe_v1.3.0_Setup.exe
          WINDOWS_USER_GUIDE.md
          README.md
        retention-days: 30
        
    - name: ğŸ‰ Build Summary
      run: |
        Write-Host ""
        Write-Host "ğŸŠ Build Completed Successfully!"
        Write-Host "=================================="
        Write-Host ""
        Write-Host "ğŸ“¦ Generated Files:"
        if (Test-Path "dist/ShotPipe.exe") {
          $size = (Get-Item "dist/ShotPipe.exe").Length / 1MB
          Write-Host "  âœ… ShotPipe.exe ($([math]::Round($size, 2)) MB)"
        }
        if (Test-Path "ShotPipe_v1.3.0_Setup.exe") {
          $size = (Get-Item "ShotPipe_v1.3.0_Setup.exe").Length / 1MB
          Write-Host "  âœ… ShotPipe_v1.3.0_Setup.exe ($([math]::Round($size, 2)) MB)"
        }
        Write-Host ""
        Write-Host "ğŸ“¥ Download artifacts from the Actions tab"
        Write-Host "ğŸš€ Ready for Windows deployment!"