name: ðŸš€ Build Windows Release

on:
  push:
    tags:
      - 'v*'  # v1.0.0, v1.3.0 ë“±ì˜ íƒœê·¸ê°€ í‘¸ì‹œë  ë•Œ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜
    inputs:
      version:
        description: 'Release version (e.g., v1.3.0)'
        required: true
        default: 'v1.3.0'

jobs:
  build:
    name: ðŸ”¨ Build ShotPipe for Windows
    runs-on: windows-latest
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
    
    - name: ðŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: ðŸ”¨ Build Executable
      run: |
        echo "Building ShotPipe.exe..."
        pyinstaller shotpipe.spec --clean --noconfirm
        
    - name: âœ… Verify Build
      run: |
        if (Test-Path "dist\ShotPipe.exe") {
          $size = (Get-Item "dist\ShotPipe.exe").Length / 1MB
          Write-Output "âœ… Build successful! Size: $([math]::Round($size, 2))MB"
        } else {
          Write-Error "âŒ Build failed - ShotPipe.exe not found"
          exit 1
        }
    
    - name: ðŸ“‹ Create Release Package
      run: |
        # ë°°í¬ íŒ¨í‚¤ì§€ ë””ë ‰í† ë¦¬ ìƒì„±
        New-Item -ItemType Directory -Force -Path "release-package"
        
        # ì‹¤í–‰íŒŒì¼ ë³µì‚¬
        Copy-Item "dist\ShotPipe.exe" "release-package\"
        
        # ì‚¬ìš©ìž ê°€ì´ë“œ ë³µì‚¬
        if (Test-Path "WINDOWS_USER_GUIDE.md") {
          Copy-Item "WINDOWS_USER_GUIDE.md" "release-package\"
        }
        if (Test-Path "README.md") {
          Copy-Item "README.md" "release-package\"
        }
        
        # ë¹ ë¥¸ ì‹œìž‘ ê°€ì´ë“œ ìƒì„±
        @"
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘                    ðŸŽ¬ ShotPipe v1.3.0 ðŸŽ¬                    â•‘
        â•‘              AI Generated File â†’ Shotgrid                   â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        ðŸš€ ë¹ ë¥¸ ì‹œìž‘:
        1. ShotPipe.exe ë”ë¸”í´ë¦­
        2. F1 í‚¤ë¡œ ë§¤ë‰´ì–¼ ì—´ê¸° 
        3. "íŒŒì¼ ì²˜ë¦¬" íƒ­ì—ì„œ ì‹œìž‘

        ðŸ”§ Shotgrid ì„¤ì •:
        - ê´€ë¦¬ìžì—ê²Œ API ì •ë³´ ìš”ì²­
        - "Shotgrid ì—…ë¡œë“œ" íƒ­ì—ì„œ ì—°ê²° ì„¤ì •

        ðŸ“ž ì§€ì›:
        - ë§¤ë‰´ì–¼: F1 í‚¤ ë˜ëŠ” ë„ì›€ë§ ë©”ë‰´
        - ë¡œê·¸: í•˜ë‹¨ ë¡œê·¸ ì°½ í™•ì¸

        ì¦ê±°ìš´ ìž‘ì—… ë˜ì„¸ìš”! ðŸŽ¬
        "@ | Out-File -FilePath "release-package\README.txt" -Encoding UTF8
        
        # ZIP íŒŒì¼ ìƒì„±
        $version = "${{ github.event.inputs.version || github.ref_name }}"
        $zipName = "ShotPipe_${version}_Windows.zip"
        Compress-Archive -Path "release-package\*" -DestinationPath $zipName
        
        echo "RELEASE_ZIP=$zipName" >> $env:GITHUB_ENV
        echo "RELEASE_VERSION=$version" >> $env:GITHUB_ENV
    
    - name: ðŸ“¤ Upload Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ShotPipe-Windows-${{ env.RELEASE_VERSION }}
        path: |
          ${{ env.RELEASE_ZIP }}
          dist/ShotPipe.exe
        retention-days: 30
    
    - name: ðŸŽ‰ Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ${{ env.RELEASE_ZIP }}
        name: "ShotPipe ${{ env.RELEASE_VERSION }} - Windows Release"
        body: |
          # ðŸŽ¬ ShotPipe ${{ env.RELEASE_VERSION }} - Windows Release
          
          ## ðŸ“¦ ë‹¤ìš´ë¡œë“œ
          - **ShotPipe_${{ env.RELEASE_VERSION }}_Windows.zip** - ì™„ì „í•œ ë°°í¬ íŒ¨í‚¤ì§€
          
          ## ðŸš€ ì„¤ì¹˜ ë°©ë²•
          1. ZIP íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë° ì••ì¶• í•´ì œ
          2. `ShotPipe.exe` ë”ë¸”í´ë¦­ìœ¼ë¡œ ì‹¤í–‰
          3. F1 í‚¤ë¡œ ë§¤ë‰´ì–¼ í™•ì¸
          
          ## âœ¨ ì£¼ìš” ê¸°ëŠ¥
          - ðŸ¤– AI ìƒì„± íŒŒì¼ ìžë™ ì²˜ë¦¬
          - ðŸ“ ìŠ¤ë§ˆíŠ¸ ë„¤ì´ë° ê·œì¹™ ì ìš©  
          - ðŸŽ¯ íŒŒì¼ ìœ í˜•ë³„ íƒœìŠ¤í¬ ìžë™ í• ë‹¹
          - ðŸ”— Shotgrid ì™„ì „ ì—°ë™
          - ðŸŽ¨ ë‹¤í¬ í…Œë§ˆ UI
          - ðŸ“– F1 ë‚´ìž¥ ë§¤ë‰´ì–¼
          
          ## ðŸ“‹ ì‹œìŠ¤í…œ ìš”êµ¬ì‚¬í•­
          - Windows 10/11 (64-bit)
          - Python ì„¤ì¹˜ ë¶ˆí•„ìš” (ì‹¤í–‰íŒŒì¼ì— í¬í•¨)
          
          ## ðŸ”§ Shotgrid ì„¤ì •
          ê´€ë¦¬ìžì—ê²Œ ë‹¤ìŒ ì •ë³´ë¥¼ ìš”ì²­í•˜ì„¸ìš”:
          - ì„œë²„ URL: `https://your-studio.shotgunstudio.com`
          - ìŠ¤í¬ë¦½íŠ¸ ì´ë¦„ ë° API í‚¤
          
          **ì¦ê±°ìš´ ìž‘ì—… ë˜ì„¸ìš”!** ðŸŽŠ
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-portable:
    name: ðŸ“¦ Build Portable Package
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ðŸ“‹ Create Portable Package
      run: |
        # í¬í„°ë¸” íŒ¨í‚¤ì§€ ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p portable-package
        
        # ì†ŒìŠ¤ì½”ë“œ ë³µì‚¬
        cp -r shotpipe portable-package/
        cp -r vendor portable-package/ 2>/dev/null || echo "vendor í´ë” ì—†ìŒ"
        cp main.py requirements.txt setup_portable.bat portable-package/
        cp WINDOWS_USER_GUIDE.md README.md portable-package/ 2>/dev/null || echo "ì¼ë¶€ ë¬¸ì„œ íŒŒì¼ ì—†ìŒ"
        
        # í¬í„°ë¸” ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
        cat > portable-package/ShotPipe_Portable_Start.bat << 'EOF'
        @echo off
        chcp 65001
        cls
        echo â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        echo â•‘                    ðŸŽ¬ ShotPipe v1.3.0 ðŸŽ¬                    â•‘
        echo â•‘              AI Generated File â†’ Shotgrid                   â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        echo.
        
        echo ðŸš€ ShotPipe ì‹œìž‘ ì¤‘...
        
        :: ê°€ìƒí™˜ê²½ì´ ìžˆìœ¼ë©´ í™œì„±í™”
        if exist "venv\Scripts\activate.bat" (
            echo ðŸ”„ ê°€ìƒí™˜ê²½ í™œì„±í™”...
            call venv\Scripts\activate.bat
        )
        
        :: ShotPipe ì‹¤í–‰
        echo âœ¨ ShotPipe ì‹¤í–‰!
        python main.py
        
        if errorlevel 1 (
            echo.
            echo âŒ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
            echo ðŸ’¡ setup_portable.batë¥¼ ë¨¼ì € ì‹¤í–‰í•´ë³´ì„¸ìš”.
            pause
        )
        EOF
        
        # ZIP íŒŒì¼ ìƒì„±
        version="${{ github.event.inputs.version || github.ref_name }}"
        zip_name="ShotPipe_${version}_Portable.zip"
        cd portable-package && zip -r ../$zip_name . && cd ..
        
        echo "PORTABLE_ZIP=$zip_name" >> $GITHUB_ENV
        echo "RELEASE_VERSION=$version" >> $GITHUB_ENV
    
    - name: ðŸ“¤ Upload Portable Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ShotPipe-Portable-${{ env.RELEASE_VERSION }}
        path: ${{ env.PORTABLE_ZIP }}
        retention-days: 30
    
    - name: ðŸŽ‰ Add to Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ env.PORTABLE_ZIP }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
