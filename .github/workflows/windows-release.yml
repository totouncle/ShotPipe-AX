name: ðŸŽ¬ Windows Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.3.0)'
        required: true
        default: 'v1.3.0'

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ Install NSIS
      run: |
        choco install nsis -y
        
    - name: ðŸ“· Setup ExifTool
      run: |
        Invoke-WebRequest -Uri "https://exiftool.org/exiftool-12.70.exe" -OutFile "vendor/exiftool.exe"
        
    - name: ðŸ”§ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: ðŸ›¡ï¸ Configure Windows Defender (if needed)
      run: |
        # Windows Defender ì˜ˆì™¸ ì„¤ì • (GitHub Actions í™˜ê²½)
        Add-MpPreference -ExclusionPath "${{ github.workspace }}" -ErrorAction SilentlyContinue
        Add-MpPreference -ExclusionProcess "python.exe" -ErrorAction SilentlyContinue
        Add-MpPreference -ExclusionProcess "pyinstaller.exe" -ErrorAction SilentlyContinue
      shell: powershell
      continue-on-error: true
      
    - name: ðŸ”¨ Build Standalone Executable
      run: |
        echo "Building ShotPipe standalone executable..."
        pyinstaller --onefile --windowed --name=ShotPipe main.py
        
    - name: ðŸ“‹ Verify Build
      run: |
        if (Test-Path "dist/ShotPipe.exe") {
          $size = (Get-Item "dist/ShotPipe.exe").Length / 1MB
          Write-Host "âœ… Build successful! Size: $([math]::Round($size, 2)) MB"
        } else {
          Write-Host "âŒ Build failed!"
          exit 1
        }
      shell: powershell
      
    - name: ðŸ“¦ Create NSIS Installer
      run: |
        echo "Creating NSIS installer..."
        makensis ShotPipe_Installer.nsi
        
    - name: ðŸ—œï¸ Create Portable Package
      run: |
        # í¬í„°ë¸” íŒ¨í‚¤ì§€ ìƒì„±
        New-Item -ItemType Directory -Force -Path "ShotPipe_Portable"
        Copy-Item "dist/ShotPipe.exe" -Destination "ShotPipe_Portable/"
        Copy-Item "README.md" -Destination "ShotPipe_Portable/"
        Copy-Item "SUPER_EASY_WINDOWS_GUIDE.md" -Destination "ShotPipe_Portable/"
        Copy-Item "LICENSE.txt" -Destination "ShotPipe_Portable/" -ErrorAction SilentlyContinue
        
        # ì‹¤í–‰ ë°°ì¹˜ íŒŒì¼ ìƒì„±
        @"
        @echo off
        title ShotPipe - AI Generated File to Shotgrid
        echo ðŸŽ¬ ShotPipe ì‹œìž‘ ì¤‘...
        ShotPipe.exe
        "@ | Out-File -FilePath "ShotPipe_Portable/ShotPipe_Start.bat" -Encoding ASCII
        
        # ZIP ì••ì¶•
        Compress-Archive -Path "ShotPipe_Portable" -DestinationPath "ShotPipe_Portable.zip" -Force
      shell: powershell
      
    - name: ðŸ“Š Generate Release Notes
      run: |
        $version = "${{ github.ref_name }}"
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $version = "${{ github.event.inputs.version }}"
        }
        
        $releaseNotes = @"
        # ðŸŽ¬ ShotPipe $version - Windows Release
        
        ## ðŸ“¦ ë‹¤ìš´ë¡œë“œ ì˜µì…˜
        
        ### ðŸŽ¯ ì´ˆë³´ìžìš© (ê¶Œìž¥)
        - **ShotPipe_Setup.exe** - ì›í´ë¦­ ì¸ìŠ¤í†¨ëŸ¬
          - ë°”íƒ•í™”ë©´ ë°”ë¡œê°€ê¸° ìžë™ ìƒì„±
          - ì‹œìž‘ë©”ë‰´ ë“±ë¡
          - ì™„ì „ ìžë™ ì„¤ì¹˜
        
        ### ðŸ”§ ê³ ê¸‰ ì‚¬ìš©ìžìš©
        - **ShotPipe_Portable.zip** - í¬í„°ë¸” ë²„ì „
          - ì„¤ì¹˜ ì—†ì´ ë°”ë¡œ ì‹¤í–‰
          - USB ë“±ì— ë³µì‚¬ ê°€ëŠ¥
          - ShotPipe_Start.batìœ¼ë¡œ ì‹¤í–‰
        
        ## ðŸš€ ì„¤ì¹˜ ë°©ë²•
        
        ### 1. ê°„ë‹¨ ì„¤ì¹˜ (ì´ˆë³´ìž)
        ```
        1. ShotPipe_Setup.exe ë‹¤ìš´ë¡œë“œ
        2. ë”ë¸”í´ë¦­í•˜ì—¬ ì‹¤í–‰
        3. "Windowsì—ì„œ PCë¥¼ ë³´í˜¸í–ˆìŠµë‹ˆë‹¤" ë©”ì‹œì§€ ì‹œ:
           â†’ "ì¶”ê°€ ì •ë³´" í´ë¦­ â†’ "ì‹¤í–‰" í´ë¦­
        4. ì„¤ì¹˜ ì™„ë£Œ í›„ ë°”íƒ•í™”ë©´ ì•„ì´ì½˜ í´ë¦­
        ```
        
        ### 2. í¬í„°ë¸” ì‚¬ìš© (ê³ ê¸‰)
        ```
        1. ShotPipe_Portable.zip ë‹¤ìš´ë¡œë“œ
        2. ì›í•˜ëŠ” í´ë”ì— ì••ì¶• í•´ì œ
        3. ShotPipe_Start.bat ì‹¤í–‰
        ```
        
        ## ðŸ”§ í•„ìˆ˜ ìš”êµ¬ì‚¬í•­
        
        - **Windows 10/11** (64bit)
        - **2GB ì´ìƒ** ì €ìž¥ê³µê°„
        - **ê´€ë¦¬ìž ê¶Œí•œ** (ì„¤ì¹˜ ì‹œ)
        
        ## ðŸ“‹ ì£¼ìš” ê¸°ëŠ¥
        
        - âœ… AI ìƒì„± íŒŒì¼ ìžë™ ì²˜ë¦¬
        - âœ… Shotgrid ìžë™ ì—…ë¡œë“œ
        - âœ… ë©”íƒ€ë°ì´í„° ìžë™ ì¶”ì¶œ
        - âœ… ë°°ì¹˜ ì²˜ë¦¬ ì§€ì›
        - âœ… ì‚¬ìš©ìž ì¹œí™”ì  GUI
        
        ## ðŸ†˜ ë¬¸ì œ í•´ê²°
        
        ### Windows Defender ì°¨ë‹¨
        ```
        "ì¶”ê°€ ì •ë³´" â†’ "ì‹¤í–‰" í´ë¦­
        ë˜ëŠ” windows_defender_fix.bat ì‹¤í–‰ (ê´€ë¦¬ìž ê¶Œí•œ)
        ```
        
        ### ExifTool ì„¤ì¹˜ (ë©”íƒ€ë°ì´í„° ì²˜ë¦¬)
        ```
        install_exiftool.bat ì‹¤í–‰ (ê´€ë¦¬ìž ê¶Œí•œ)
        ```
        
        ## ðŸ“š ë¬¸ì„œ
        
        - [ì´ˆë³´ìž ê°€ì´ë“œ](SUPER_EASY_WINDOWS_GUIDE.md)
        - [ìƒì„¸ ì‚¬ìš©ìž ê°€ì´ë“œ](WINDOWS_USER_GUIDE.md)
        - [ë¹Œë“œ ê°€ì´ë“œ](WINDOWS_BUILD_INSTRUCTIONS.md)
        
        ## ðŸŽ¬ ì¦ê±°ìš´ ìž‘ì—… ë˜ì„¸ìš”!
        
        AI ìƒì„± ì½˜í…ì¸ ë¥¼ Shotgridë¡œ íš¨ìœ¨ì ìœ¼ë¡œ ì—…ë¡œë“œí•˜ì„¸ìš”!
        "@
        
        $releaseNotes | Out-File -FilePath "RELEASE_NOTES.md" -Encoding UTF8
      shell: powershell
      
    - name: ðŸ·ï¸ Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ShotPipe_Setup.exe
          ShotPipe_Portable.zip
        body_path: RELEASE_NOTES.md
        draft: false
        prerelease: false
        tag_name: ${{ github.ref_name || github.event.inputs.version }}
        name: ðŸŽ¬ ShotPipe ${{ github.ref_name || github.event.inputs.version }} - Windows Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ“Š Build Summary
      run: |
        echo "## ðŸŽ‰ Build Completed Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Generated Files:" >> $GITHUB_STEP_SUMMARY
        if (Test-Path "ShotPipe_Setup.exe") {
          $installerSize = [math]::Round((Get-Item "ShotPipe_Setup.exe").Length / 1MB, 2)
          echo "- âœ… **ShotPipe_Setup.exe** ($installerSize MB)" >> $GITHUB_STEP_SUMMARY
        }
        if (Test-Path "ShotPipe_Portable.zip") {
          $portableSize = [math]::Round((Get-Item "ShotPipe_Portable.zip").Length / 1MB, 2)
          echo "- âœ… **ShotPipe_Portable.zip** ($portableSize MB)" >> $GITHUB_STEP_SUMMARY
        }
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ¯ Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "1. Download the release files" >> $GITHUB_STEP_SUMMARY
        echo "2. Test installation on clean Windows machine" >> $GITHUB_STEP_SUMMARY
        echo "3. Distribute to users" >> $GITHUB_STEP_SUMMARY
        echo "4. Update documentation if needed" >> $GITHUB_STEP_SUMMARY
      shell: powershell 